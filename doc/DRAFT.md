### React Server Components (RSC) 脆弱性のPoCプロジェクト提案

#### 1. 脆弱性のメカニズム
React Server Components (RSC) の脆弱性（主にCVE-2025-55182、別名React2Shell）は、RSCのデータシリアライズ/デシリアライズプロトコル（Flightプロトコル）におけるセキュリティ欠陥に起因します。この脆弱性は、Next.jsなどのフレームワークでRSCを活用したアプリケーションに影響を及ぼし、認証不要のリモートコード実行（RCE）を可能にします。以下にメカニズムを詳細に説明します。

- **背景と動作原理**:
  - RSCはサーバー側でReactコンポーネントをレンダリングし、シリアライズされたペイロード（Flight payload）をクライアントに送信します。クライアントからのリクエスト（例: サーバーアクション）を受け取ったサーバーは、このペイロードをデシリアライズして処理します。
  - Flightプロトコルは、モジュールエクスポートのメタデータを扱い、サーバー上で動的に関数やオブジェクトを解決します。CommonJSスタイルのエクスポート（例: `module.exports = { action: fn }`）が一般的です。

- **脆弱性の核心**:
  - デシリアライズ時に、クライアントが送信したペイロード内のプロパティ（例: `.constructor`や`.prototype`）を十分に検証せず、信頼してアクセスします。具体的に、`hasOwnProperty`や型チェックが不十分で、攻撃者がグローバルオブジェクト（例: `Function`コンストラクタ）にアクセス可能になります。
  - 攻撃者は、ペイロードを細工してサーバーアクションを偽装。例: サーバー側でエクスポートされた関数を継承し、`.constructor`経由で任意のJavaScriptコードを注入・実行します。これにより、サーバー上でOSコマンド実行（例: `child_process.exec`経由のシェルコマンド）が発生します。
  - 影響を受けるバージョン: `react-server-dom-webpack`の19.0.0〜19.2.0。Next.jsでは15.xおよび16.x（一部の14.x canary版）がこれを依存として使用するため、App Router経由で露出します。パッチ版では、デシリアライズ時のプロパティフィルタリングとサニタイズが強化されています。

- **攻撃の流れ（高レベル）**:
  1. 攻撃者が悪意あるFlight payloadを作成（複数チャンク形式で、アクションIDを指定）。
  2. HTTP POSTリクエストでサーバーのエンドポイント（例: Next.jsの`/api`ルート）に送信。
  3. サーバーがペイロードをデシリアライズし、注入されたコードを実行。結果として、サーバーファイルの読み取り/書き込み、コマンド実行が可能。
  - リアルライフの影響: 公開されたNext.jsアプリケーション（例: eコマースサイトやAPIサーバー）で発生した場合、データ漏洩、DDoS、またはインフラ乗っ取りにつながる。認証不要のため、公開エンドポイントを持つシステムが特に危険。

- **緩和策**:
  - 依存バージョンをパッチ版（例: `react-server-dom-webpack@19.3.0`以上）にアップデート。
  - 入力検証の強化（カスタムミドルウェアでペイロード検査）。
  - 最小権限原則の適用（サーバープロセスを制限）。

この脆弱性は、RSCの利便性（サーバー側レンダリングの効率化）とトレードオフで生じたもので、類似のシリアライズ脆弱性（例: JavaのRCE）と共通点があります。既存PoC（例: GitHubの公開リポジトリ）を解析し、メカニズムを理解した上で自力実装します。

#### 2. PoCの目的と正当性
本PoCプロジェクトの目的は、既存システムのセキュリティ担保を検証し、RSC脆弱性のリアルライフ影響を評価することです。Next.jsを基盤とした最小アプリケーションを構築し、脆弱バージョンを意図的に使用してPoCを実行。以下に、違法性阻却事由、道徳性、技術的正当性を詳細に説明します。これにより、上司および開発メンバーへの共有が可能となり、プロジェクトの透明性を確保します。

- **目的の詳細**:
  - **セキュリティ検証**: 社内既存システム（Next.jsベースのウェブアプリケーション）でこの脆弱性が再現可能かをテスト。PoC成功時は、即時パッチ適用や追加対策を提案し、潜在リスクを低減。
  - **リアルライフ影響の評価**: 最小構成（純粋Node.js）ではなく、Next.jsのApp Routerを使用した現実的なセットアップでテスト。実際のデプロイ環境（例: Vercelや自社サーバー）を模倣し、影響度（データ漏洩の可能性）を定量評価。
  - **教育・啓発**: 開発チームに脆弱性のメカニズムを共有し、セキュアコーディングのベストプラクティスを促進。PoCはローカル環境（WSL）限定で、外部システムへの影響なし。
  - **アウトプット**: PoC実行結果をレポート化（ログ、スクリーンショット）。成功/失敗を基に、システムの脆弱性スコアリングを実施。

- **違法性阻却事由（合法性）**:
  - 本PoCは、自己所有のローカル環境でのみ実行され、他者のシステムへのアクセス/攻撃を一切行いません。サイバーセキュリティ法（例: 不正アクセス禁止法）では、自己検証目的のPoCは合法とみなされます（参考: NISTガイドライン SP 800-115）。
  - 既存PoCの解析はオープンソース利用に該当し、著作権侵害なし。実際のコーディングはオリジナルとし、公開せず社内限定。
  - 目的が防御的（脆弱性発見・修正）であり、攻撃的利用（例: 実際のハッキング）でないため、刑法の幇助罪などに該当せず。法務部確認済みの場合、追加で文書化可能。
  - 米国法（CFAA）でも、同意済みシステム（自社）でのテストは免責。国際的に見て、OWASPの倫理ガイドラインに準拠。

- **道徳性**:
  - 本プロジェクトは、セキュリティ向上を目的とし、社会的責任を果たすもの。脆弱性を悪用せず、発見を通じて業界全体の安全性を高めます（例: 類似脆弱性の事前対策）。
  - 透明性確保: 上司/チームへの事前説明と承認を前提。PoCコードはバージョン管理（Git）で追跡し、倫理的レビューを実施。
  - 潜在被害の防止: リアルライフで発生すれば顧客データ漏洩を招くため、事前PoCは道徳的に正当。ハッカーの視点で考える「レッドチーム」アプローチを採用し、防御強化に寄与。
  - 制限: PoCはテストコマンド（例: `echo "vulnerable"`）に限定し、破壊的動作を避ける。結果は機密扱い。

- **技術的正当性と開発メンバー共有**:
  - **技術的価値**: RSCの採用が増える中（Next.jsユーザー数増加）、早期検証が競争力強化につながる。PoCを通じて、依存管理の重要性（バージョンピニング）を学び、CI/CDパイプラインにセキュリティスキャンを統合可能。
  - **共有の利点**: 開発メンバーにメカニズムを説明し、ハンズオンセッションを実施。コードレビューでPoCを検証し、チームのスキル向上を図る。ドキュメント化により、再利用性確保。
  - **リスク管理**: 失敗リスク低（ローカル限定）。成功時は、CVEデータベース参照で対策を即適用。技術的正当性は、SANS InstituteのPoCガイドラインに基づく。
  - **メンバーへの説明ポイント**: 
    - なぜNext.jsか: 社内システムのリアリティを反映。最小構成では過小評価される影響を正確に把握。
    - 自力コーディングの理由: 既存PoC依存を避け、理解深化。オリジナルコードでカスタマイズ可能（例: 社内ログ統合）。
    - 共有方法: Slack/ドキュメント共有。Q&Aセッションで疑問解消。

本プロジェクトは、セキュリティ成熟度モデル（例: BSIMM）に沿ったもので、実施により社内セキュリティレベル向上を期待します。承認後、即時着手可能。

#### 3. 環境構築の手順（Next.jsベース、脆弱バージョン固定）
WSL環境を前提とし、Node.js v25、pnpmを使用。Next.jsを脆弱対応前バージョン（15.0.0）に固定し、App RouterでRSCを有効化。最小アプリケーションとして、サーバーアクションを含むページを作成。

1. **Node.js v25のインストール（nvm使用、未インストールの場合）**:
   ```
   curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
   source ~/.bashrc
   nvm install 25
   nvm use 25
   node -v  # 確認: v25.x.x
   ```

2. **pnpmのインストール**:
   ```
   npm install -g pnpm
   pnpm -v  # 確認
   ```

3. **プロジェクト作成と依存固定**:
   ```
   mkdir next-rsc-poc
   cd next-rsc-poc
   pnpm init
   pnpm add next@15.0.0 react@19.0.0 react-dom@19.0.0 react-server-dom-webpack@19.0.0
   # 脆弱バージョンを固定。Next.js 15.0.0はRSCをサポートし、内部依存にreact-server-dom-webpack 19.0.0を含む
   ```

4. **Next.js設定ファイル作成**:
   - `next.config.js`:
     ```
     module.exports = {
       experimental: {
         appDir: true,  // App Router有効
         serverActions: true,  // サーバーアクション有効（脆弱性露出点）
       },
     };
     ```

5. **最小アプリケーションの実装**:
   - ディレクトリ作成: `mkdir app`
   - `app/page.js`（サーバーコンポーネント例）:
     ```
     'use server';  // サーバー側指定

     export async function vulnerableAction(data) {
       // 脆弱なサーバーアクション: 入力検証なしで実行
       console.log('Executing:', data);
       // ここにPoCで注入されるコードが実行される可能性
     }

     export default function Home() {
       return <div>Vulnerable RSC Page</div>;
     }
     ```

6. **package.jsonスクリプト追加**:
   ```
   "scripts": {
     "dev": "next dev",
     "build": "next build",
     "start": "next start"
   }
   ```

7. **インストールと起動**:
   ```
   pnpm install
   pnpm dev  # http://localhost:3000 で確認。脆弱エンドポイント露出
   ```

この環境でPoCコードを自力実装（既存PoC解析参考）。テスト時は、curlでペイロード送信（例: `curl -X POST http://localhost:3000/api -d '{悪意ペイロード}'`）。構築後、PoC開発へ移行。